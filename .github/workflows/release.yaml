name: Publish Package to NuGet
on:
  release:
    types: [created]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_VERSION: 9.0.101

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Retrieve the release tag
      - if: startsWith(github.ref, 'refs/tags/')
        name: Get release tag
        id: get_tag
        run: echo "RELEASE_TAG=${{ github.ref }}" >> $GITHUB_ENV

      # Download the NuGet packages created in the build job
      - uses: actions/download-artifact@v4
        with:
          name: nuget-${{ env.RELEASE_TAG }}
          path: .

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Publish all NuGet packages to NuGet.org
      # Use --skip-duplicate to prevent errors if a package with the same version already exists.
      # If you retry a failed workflow, already published packages will be skipped without error.
      - name: Publish NuGet package
        run: bin/publish . ${{ secrets.NUGET_API_KEY }}
        shell: bash